
(function(window, angular){'use strict';

    angular.module('ngTable', ['ng'])
        .info({angularVersion:'1.6.8'})
        .provider('$$table', function $$TableProvider(){
            this.$get = $$table;
        });

    angular.module('ngTable')
        .directive('ngtable', function(){
           return {
               restrict: 'AE',
               controller: ['$scope', '$element','$$table',
                   function TableController($scope,$element,$$table){

                       var display = parseInt($element.attr('display')||15);
                       $$table.init($element.attr('url'), {
                           page: 1,
                           limit: display,
                           sortIndex: $element.attr('index')|| '',
                           sortOrder: $element.attr('order')
                       },function(rows, pageCount, rowCount){

                           $scope.rows = rows;

                       }).generate($scope).then(function(element){
                           $element.html('').append(element);
                       });

                   }
               ]
           };
        })

    function $$table($http, $compile, $templateRequest, $sce, $q){

        var template =
            '<table class="table table-hover">'+'' +
            '<thead>'+
                '<th>Name</th>'+
                '<th>Email</th>'+
            '</thead>'+
            '<tbody>' +
            '<tr ng-repeat="row in rows">' +
            '<td><% row.name %></td>'+
            '<td><% row.email %></td>'+
            '</tr>'+
            '</tbody>'+
            '</table>'

        var $scope, $url, $params, $data;

        function request(url, params){
            $http.get(url, {params: params}).then(function(response){
                $data = response.data;
                $scope($data.list, $data.pages, $data.rows);
                console.log($data);
            });
        }

        return {
            init: function(url, params, scope){
                $url = url;
                $params = params;
                $scope = scope;
                request($url, $params);
                return this;
            },
            generate: function(scope){
                var deferred = $q.defer();
                deferred.resolve($compile(template)(scope));
                return deferred.promise;
            },
            params: function(){
                return $params;
            }
        };

    }

    $$table.$inject=['$http', '$compile', '$templateRequest', '$sce', '$q'];

})(window, window.angular);